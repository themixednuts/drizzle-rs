{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/themixednuts/drizzle-rs/master/cli/schema.json",
  "title": "Drizzle Configuration",
  "description": "Configuration schema for drizzle-rs CLI tool",
  "type": "object",
  "definitions": {
    "envOr": {
      "description": "A value that can be a direct string or an environment variable reference",
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["env"],
          "properties": {
            "env": {
              "type": "string",
              "description": "Environment variable name"
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "dialect": {
      "description": "Database dialect",
      "type": "string",
      "enum": ["sqlite", "postgresql", "postgres", "mysql", "turso", "singlestore"]
    },
    "driver": {
      "description": "Optional driver for specific database implementations",
      "type": "string",
      "enum": [
        "d1-http",
        "expo",
        "durable-sqlite",
        "sqlite-cloud",
        "aws-data-api",
        "pglite"
      ]
    },
    "schemaPath": {
      "description": "Path or array of paths to schema files (glob patterns supported)",
      "oneOf": [
        { "type": "string" },
        {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        }
      ],
      "default": "src/schema.rs"
    },
    "filter": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "array",
          "items": { "type": "string" }
        }
      ]
    },
    "migrations": {
      "description": "Migration table configuration",
      "type": "object",
      "properties": {
        "table": {
          "description": "Custom table name for migrations (default: __drizzle_migrations)",
          "type": "string"
        },
        "schema": {
          "description": "Schema for migrations table (PostgreSQL only)",
          "type": "string"
        },
        "prefix": {
          "description": "Migration file naming prefix",
          "type": "string",
          "enum": ["index", "timestamp", "supabase", "unix", "none"]
        }
      },
      "additionalProperties": false
    },
    "dbCredentials": {
      "description": "Database credentials",
      "oneOf": [
        {
          "type": "object",
          "description": "URL-based credentials",
          "required": ["url"],
          "properties": {
            "url": { "$ref": "#/definitions/envOr" },
            "authToken": { "$ref": "#/definitions/envOr" }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "Host-based credentials",
          "required": ["host", "database"],
          "properties": {
            "host": { "$ref": "#/definitions/envOr" },
            "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
            "user": { "$ref": "#/definitions/envOr" },
            "password": { "$ref": "#/definitions/envOr" },
            "database": { "$ref": "#/definitions/envOr" },
            "ssl": {
              "oneOf": [
                { "type": "boolean" },
                { "type": "string", "enum": ["require", "allow", "prefer", "verify-full", "disable"] }
              ]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "Cloudflare D1 credentials",
          "required": ["accountId", "databaseId", "token"],
          "properties": {
            "accountId": { "$ref": "#/definitions/envOr" },
            "databaseId": { "$ref": "#/definitions/envOr" },
            "token": { "$ref": "#/definitions/envOr" }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "description": "AWS Data API credentials",
          "required": ["database", "secretArn", "resourceArn"],
          "properties": {
            "database": { "$ref": "#/definitions/envOr" },
            "secretArn": { "$ref": "#/definitions/envOr" },
            "resourceArn": { "$ref": "#/definitions/envOr" }
          },
          "additionalProperties": false
        }
      ]
    },
    "databaseConfig": {
      "description": "Configuration for a single database",
      "type": "object",
      "required": ["dialect"],
      "properties": {
        "dialect": { "$ref": "#/definitions/dialect" },
        "driver": { "$ref": "#/definitions/driver" },
        "schema": { "$ref": "#/definitions/schemaPath" },
        "out": {
          "description": "Output directory for migrations",
          "type": "string"
        },
        "breakpoints": {
          "description": "Whether to use SQL breakpoints in generated migrations",
          "type": "boolean",
          "default": true
        },
        "tablesFilter": {
          "description": "Table filter for push/introspect commands",
          "$ref": "#/definitions/filter"
        },
        "schemaFilter": {
          "description": "Schema filter for PostgreSQL",
          "$ref": "#/definitions/filter"
        },
        "verbose": {
          "description": "Verbose output",
          "type": "boolean",
          "default": false
        },
        "strict": {
          "description": "Strict mode (require confirmation)",
          "type": "boolean",
          "default": false
        },
        "migrations": { "$ref": "#/definitions/migrations" },
        "dbCredentials": { "$ref": "#/definitions/dbCredentials" }
      },
      "additionalProperties": false
    }
  },
  "oneOf": [
    {
      "description": "Single database configuration (legacy/simple mode)",
      "type": "object",
      "required": ["dialect"],
      "properties": {
        "dialect": { "$ref": "#/definitions/dialect" },
        "driver": { "$ref": "#/definitions/driver" },
        "schema": { "$ref": "#/definitions/schemaPath" },
        "out": {
          "description": "Output directory for migrations",
          "type": "string",
          "default": "./drizzle"
        },
        "breakpoints": {
          "description": "Whether to use SQL breakpoints in generated migrations",
          "type": "boolean",
          "default": true
        },
        "tablesFilter": {
          "description": "Table filter for push/introspect commands",
          "$ref": "#/definitions/filter"
        },
        "schemaFilter": {
          "description": "Schema filter for PostgreSQL",
          "$ref": "#/definitions/filter"
        },
        "extensionsFilters": {
          "description": "Extensions filter for PostgreSQL",
          "$ref": "#/definitions/filter"
        },
        "verbose": {
          "description": "Verbose output for push command",
          "type": "boolean",
          "default": false
        },
        "strict": {
          "description": "Strict mode for push command",
          "type": "boolean",
          "default": false
        },
        "casing": {
          "description": "Casing mode for generated code",
          "type": "string",
          "enum": ["camel_case", "snake_case"]
        },
        "migrations": { "$ref": "#/definitions/migrations" },
        "introspect": {
          "description": "Introspection configuration",
          "type": "object",
          "properties": {
            "casing": {
              "type": "string",
              "enum": ["camel", "preserve"],
              "default": "camel"
            }
          },
          "additionalProperties": false
        },
        "entities": {
          "description": "Entity configuration (roles, policies, etc.)",
          "type": "object",
          "properties": {
            "roles": {
              "oneOf": [
                { "type": "boolean" },
                {
                  "type": "object",
                  "properties": {
                    "provider": { "type": "string" },
                    "exclude": { "type": "array", "items": { "type": "string" } },
                    "include": { "type": "array", "items": { "type": "string" } }
                  },
                  "additionalProperties": false
                }
              ]
            }
          },
          "additionalProperties": false
        },
        "dbCredentials": { "$ref": "#/definitions/dbCredentials" }
      },
      "additionalProperties": false
    },
    {
      "description": "Multi-database configuration",
      "type": "object",
      "required": ["databases"],
      "properties": {
        "databases": {
          "description": "Named database configurations",
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/databaseConfig" },
          "minProperties": 1
        }
      },
      "additionalProperties": false
    }
  ]
}
