//! Relation metadata types and traits.
//!
//! These traits describe foreign key relationships between tables.
//! They are automatically implemented by the `#[SQLiteTable]` and `#[PostgresTable]`
//! macros for tables that declare `#[column(references = ...)]` attributes,
//! and by the `SQLiteSchema` / `PostgresSchema` derive macros which also
//! generate reverse (one-to-many) relations.

/// The type of a relation between two tables.
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum RelationType {
    /// Many rows in the source table reference one row in the target table.
    /// Generated from a foreign key on the source table.
    ManyToOne,
    /// One row in the source table is referenced by many rows in the target table.
    /// Generated as the reverse of a ManyToOne relation.
    OneToMany,
}

/// Describes a single foreign key relation between two tables.
///
/// Each relation is represented as a zero-sized type (ZST) with a static
/// implementation of this trait, generated by proc macros.
pub trait Relation: Send + Sync + 'static {
    /// The name of the table that holds the foreign key column(s).
    fn source_table(&self) -> &'static str;

    /// The name of the table being referenced.
    fn target_table(&self) -> &'static str;

    /// The foreign key column name(s) on the source table.
    fn fk_columns(&self) -> &'static [&'static str];

    /// The referenced column name(s) on the target table.
    fn ref_columns(&self) -> &'static [&'static str];

    /// Whether this is a ManyToOne or OneToMany relation.
    fn relation_type(&self) -> RelationType;
}

/// Implemented on table structs that have outgoing foreign key relations.
///
/// Generated by `#[SQLiteTable]` / `#[PostgresTable]` for tables with
/// `#[column(references = ...)]` attributes.
pub trait HasRelations {
    /// Returns all outgoing (ManyToOne) relations from this table.
    fn outgoing_relations() -> &'static [&'static dyn Relation];
}

/// Implemented on schema structs to provide a complete view of all relations
/// (both outgoing ManyToOne and reverse OneToMany).
///
/// Generated by `#[derive(SQLiteSchema)]` / `#[derive(PostgresSchema)]`.
pub trait SchemaRelations {
    /// Returns all relations (outgoing and reverse) across the schema.
    ///
    /// The returned slice is lazily initialized on first call and cached
    /// for the lifetime of the program.
    fn all_relations(&self) -> &'static [&'static dyn Relation];
}

/// A reverse (OneToMany) view of an existing ManyToOne relation.
///
/// Given a `ManyToOne` relation from A -> B, the reverse is a
/// `OneToMany` relation from B -> A (same FK/ref columns, swapped
/// source/target, flipped relation type).
///
/// Used internally by schema macros to generate reverse relations
/// without additional ZSTs.
pub struct ReverseRelation {
    /// The underlying outgoing relation being reversed.
    inner: &'static dyn Relation,
}

impl ReverseRelation {
    /// Create a new reverse relation from a ManyToOne relation.
    pub const fn new(inner: &'static dyn Relation) -> Self {
        Self { inner }
    }
}

impl Relation for ReverseRelation {
    fn source_table(&self) -> &'static str {
        // Reversed: the target of the original becomes the source
        self.inner.target_table()
    }

    fn target_table(&self) -> &'static str {
        // Reversed: the source of the original becomes the target
        self.inner.source_table()
    }

    fn fk_columns(&self) -> &'static [&'static str] {
        // FK columns stay the same (they're on the original source table)
        self.inner.fk_columns()
    }

    fn ref_columns(&self) -> &'static [&'static str] {
        // Ref columns stay the same (they're on the original target table)
        self.inner.ref_columns()
    }

    fn relation_type(&self) -> RelationType {
        RelationType::OneToMany
    }
}
