name: Turso Tests (Experimental)

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  get-rust-version:
    name: Get Rust Version
    runs-on: ubuntu-latest
    outputs:
      rust-version: ${{ steps.rust-version.outputs.version }}
    steps:
    - uses: actions/checkout@v4
    - name: Extract Rust version from Cargo.toml
      id: rust-version
      run: |
        RUST_VERSION=$(grep '^rust-version = ' Cargo.toml | sed 's/rust-version = "\(.*\)"/\1/')
        echo "version=$RUST_VERSION" >> $GITHUB_OUTPUT
        echo "Detected Rust version: $RUST_VERSION"

  turso-tests:
    name: Turso Tests
    runs-on: ubuntu-latest
    needs: get-rust-version
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        features:
          - "turso"
          - "turso,uuid"
          - "turso,serde"
          - "turso,uuid,serde"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ needs.get-rust-version.outputs.rust-version }}
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Run turso tests with ${{ matrix.features }}
      run: |
        echo "::notice::Testing turso with features: ${{ matrix.features }}"
        if cargo test --workspace --features "${{ matrix.features }}" --verbose; then
          echo "::notice::✅ Turso tests passed with features: ${{ matrix.features }}"
        else
          echo "::warning::❌ Turso tests failed with features: ${{ matrix.features }} (experimental)"
          exit 1
        fi

  turso-examples:
    name: Turso Examples
    runs-on: ubuntu-latest
    needs: get-rust-version
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        features:
          - "turso"
          - "turso,uuid,serde"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ needs.get-rust-version.outputs.rust-version }}
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Run turso examples with ${{ matrix.features }}
      run: |
        echo "::notice::Running turso examples with features: ${{ matrix.features }}"
        if find examples -name "*.rs" | grep -q "turso" && cargo run --example turso --features "${{ matrix.features }}"; then
          echo "::notice::✅ Turso examples ran successfully with features: ${{ matrix.features }}"
        else
          echo "::warning::❌ Turso examples failed or not found with features: ${{ matrix.features }} (experimental)"
        fi