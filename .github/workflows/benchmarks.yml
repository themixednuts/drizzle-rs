name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark-sqlite:
    name: Benchmark SQLite (${{ matrix.platform }})
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: bench-${{ matrix.platform }}
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run SQLite benchmarks
        shell: bash
        run: |
          cargo bench --bench sqlite --features "rusqlite" > benchmark_raw.txt 2>&1 || true
          if grep -q "Timer precision" benchmark_raw.txt; then
            sed -n '/Timer precision/,$p' benchmark_raw.txt > benchmark_output.txt
          else
            echo "No benchmark results found" > benchmark_output.txt
            cat benchmark_raw.txt >> benchmark_output.txt
          fi

      - name: Create report
        shell: bash
        run: |
          {
            echo "# SQLite Benchmark Results - ${{ matrix.platform }}"
            echo ""
            echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Platform:** ${{ runner.os }} (${{ runner.arch }})"
            echo ""
            echo '```'
            cat benchmark_output.txt
            echo '```'
          } > "sqlite-${{ matrix.platform }}.md"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-sqlite-${{ matrix.platform }}
          path: sqlite-${{ matrix.platform }}.md
          retention-days: 30

      # Cache baseline results on main branch for regression detection
      - name: Save baseline
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: benchmark_output.txt
          key: bench-sqlite-baseline-${{ matrix.platform }}-${{ github.sha }}

      # On PRs, compare against the most recent main baseline
      - name: Restore baseline
        if: github.event_name == 'pull_request'
        id: restore-baseline
        uses: actions/cache/restore@v4
        with:
          path: baseline_output.txt
          key: bench-sqlite-baseline-${{ matrix.platform }}-
          restore-keys: |
            bench-sqlite-baseline-${{ matrix.platform }}-

      - name: Compare with baseline
        if: github.event_name == 'pull_request' && steps.restore-baseline.outputs.cache-hit == 'true'
        shell: bash
        run: |
          echo "## Benchmark Comparison (SQLite - ${{ matrix.platform }})" > comparison.md
          echo "" >> comparison.md
          echo "Comparing PR results against main branch baseline." >> comparison.md
          echo "" >> comparison.md
          echo "<details><summary>Current results</summary>" >> comparison.md
          echo "" >> comparison.md
          echo '```' >> comparison.md
          cat benchmark_output.txt >> comparison.md
          echo '```' >> comparison.md
          echo "</details>" >> comparison.md
          echo "" >> comparison.md
          echo "<details><summary>Baseline (main)</summary>" >> comparison.md
          echo "" >> comparison.md
          echo '```' >> comparison.md
          cat baseline_output.txt >> comparison.md
          echo '```' >> comparison.md
          echo "</details>" >> comparison.md

      - name: Upload comparison
        if: github.event_name == 'pull_request' && steps.restore-baseline.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-comparison-sqlite-${{ matrix.platform }}
          path: comparison.md
          retention-days: 7

  benchmark-postgres:
    name: Benchmark PostgreSQL (linux)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: drizzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: bench-postgres
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run PostgreSQL sync benchmarks
        env:
          DATABASE_URL: "host=localhost user=postgres password=postgres dbname=drizzle_test"
        shell: bash
        run: |
          cargo bench --bench postgres --features "postgres-sync" > sync_raw.txt 2>&1 || true
          if grep -q "Timer precision" sync_raw.txt; then
            sed -n '/Timer precision/,$p' sync_raw.txt > sync_output.txt
          else
            echo "No benchmark results found" > sync_output.txt
            cat sync_raw.txt >> sync_output.txt
          fi

      - name: Run PostgreSQL async benchmarks
        env:
          DATABASE_URL: "host=localhost user=postgres password=postgres dbname=drizzle_test"
        shell: bash
        run: |
          cargo bench --bench postgres --features "tokio-postgres" > async_raw.txt 2>&1 || true
          if grep -q "Timer precision" async_raw.txt; then
            sed -n '/Timer precision/,$p' async_raw.txt > async_output.txt
          else
            echo "No benchmark results found" > async_output.txt
            cat async_raw.txt >> async_output.txt
          fi

      - name: Create report
        shell: bash
        run: |
          {
            echo "# PostgreSQL Benchmark Results"
            echo ""
            echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "**Commit:** ${{ github.sha }}"
            echo "**Platform:** ${{ runner.os }} (${{ runner.arch }})"
            echo ""
            echo "## postgres-sync"
            echo ""
            echo '```'
            cat sync_output.txt
            echo '```'
            echo ""
            echo "## tokio-postgres"
            echo ""
            echo '```'
            cat async_output.txt
            echo '```'
          } > "postgres-linux.md"

          # Combine for baseline comparison
          cat sync_output.txt > benchmark_output.txt
          echo "" >> benchmark_output.txt
          cat async_output.txt >> benchmark_output.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-postgres-linux
          path: postgres-linux.md
          retention-days: 30

      - name: Save baseline
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: benchmark_output.txt
          key: bench-postgres-baseline-${{ github.sha }}

      - name: Restore baseline
        if: github.event_name == 'pull_request'
        id: restore-baseline
        uses: actions/cache/restore@v4
        with:
          path: baseline_output.txt
          key: bench-postgres-baseline-
          restore-keys: |
            bench-postgres-baseline-

      - name: Compare with baseline
        if: github.event_name == 'pull_request' && steps.restore-baseline.outputs.cache-hit == 'true'
        shell: bash
        run: |
          echo "## Benchmark Comparison (PostgreSQL)" > comparison.md
          echo "" >> comparison.md
          echo "Comparing PR results against main branch baseline." >> comparison.md
          echo "" >> comparison.md
          echo "<details><summary>Current results</summary>" >> comparison.md
          echo "" >> comparison.md
          echo '```' >> comparison.md
          cat benchmark_output.txt >> comparison.md
          echo '```' >> comparison.md
          echo "</details>" >> comparison.md
          echo "" >> comparison.md
          echo "<details><summary>Baseline (main)</summary>" >> comparison.md
          echo "" >> comparison.md
          echo '```' >> comparison.md
          cat baseline_output.txt >> comparison.md
          echo '```' >> comparison.md
          echo "</details>" >> comparison.md

      - name: Upload comparison
        if: github.event_name == 'pull_request' && steps.restore-baseline.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-comparison-postgres
          path: comparison.md
          retention-days: 7
