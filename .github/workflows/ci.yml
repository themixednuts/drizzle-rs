name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  get-rust-version:
    name: Get Rust Version
    runs-on: ubuntu-latest
    outputs:
      rust-version: ${{ steps.rust-version.outputs.version }}
    steps:
    - uses: actions/checkout@v4
    - name: Extract Rust version from Cargo.toml
      id: rust-version
      run: |
        RUST_VERSION=$(grep '^rust-version = ' Cargo.toml | sed 's/rust-version = "\(.*\)"/\1/')
        echo "version=$RUST_VERSION" >> $GITHUB_OUTPUT
        echo "Detected Rust version: $RUST_VERSION"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: get-rust-version
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      run: cargo clippy --features "rusqlite,libsql,uuid,serde" -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [get-rust-version, lint]
    strategy:
      fail-fast: false
      matrix:
        features:
          - "rusqlite,libsql"
          - "rusqlite,libsql,uuid"
          - "rusqlite,libsql,serde"
          - "rusqlite,libsql,uuid,serde"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ needs.get-rust-version.outputs.rust-version }}
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Run tests with ${{ matrix.features }}
      run: cargo test --workspace --features "${{ matrix.features }}" --verbose
    
    - name: Run examples with ${{ matrix.features }}
      run: cargo run --example rusqlite --features "${{ matrix.features }}"


  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [get-rust-version, lint]
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ needs.get-rust-version.outputs.rust-version }}
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Check documentation
      run: cargo doc --features "rusqlite,libsql,uuid,serde" --no-deps --document-private-items

  build-check:
    name: Build Check (stable/beta/nightly)
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      matrix:
        rust: [stable, beta, nightly]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust ${{ matrix.rust }}
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Build with both drivers
      run: cargo build --features "rusqlite,libsql,uuid,serde"

  minimum-versions:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    needs: [get-rust-version, lint]
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust (MSRV)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ needs.get-rust-version.outputs.rust-version }}
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Check MSRV with both drivers
      run: cargo check --features "rusqlite,libsql,uuid,serde"
